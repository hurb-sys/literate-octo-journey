/* ===== í”ŒëŸ¬í”¼ë„ ê²Œì„ (í¬ë¦¬ìŠ¤ë§ˆìŠ¤) ===== */
const cvs = document.getElementById("game");
const g = cvs.getContext("2d");

const W = 320, H = 480;
const birdX = 80, birdR = 14;

let birdY, birdV;
let pipes, frame, score;
let started, dead;

const gravity = 0.28;     // ë„ˆë¬´ ì„¸ë©´ ë°”ë¡œ ì¶”ë½í•´ì„œ "ì£½ì–´ìˆìŒ" ëŠë‚Œ
const jumpV   = -7.2;
const gap     = 140;
const pipeW   = 46;
const speed   = 2.2;

function resetGame(){
  birdY = H/2;
  birdV = 0;
  pipes = [];
  frame = 0;
  score = 0;
  started = false; // âœ… ì‹œì‘ ì „ ìƒíƒœ
  dead = false;
}

function spawnPipe(){
  const top = Math.random() * 220 + 40; // 40~260
  pipes.push({ x: W + 10, top, passed:false });
}

function drawBackground(){
  // í•˜ëŠ˜ ê·¸ë¼ë°ì´ì…˜
  const grad = g.createLinearGradient(0,0,0,H);
  grad.addColorStop(0, "#1b2a4a");
  grad.addColorStop(1, "#0b1020");
  g.fillStyle = grad;
  g.fillRect(0,0,W,H);

  // ë°”ë‹¥(ëˆˆ)
  g.fillStyle = "rgba(255,255,255,.12)";
  g.fillRect(0, H-40, W, 40);
}

function drawBird(){
  // ëª¸
  g.fillStyle = "#ff5252";
  g.beginPath();
  g.arc(birdX, birdY, birdR, 0, Math.PI*2);
  g.fill();

  // ì‚°íƒ€ ëª¨ì(ê°„ë‹¨)
  g.fillStyle = "#e53935";
  g.fillRect(birdX-12, birdY-30, 24, 10);
  g.fillStyle = "#fff";
  g.fillRect(birdX-12, birdY-34, 24, 6);
}

function drawPipes(){
  g.fillStyle = "#e0f7fa"; // ëˆˆê¸°ë‘¥
  for(const p of pipes){
    g.fillRect(p.x, 0, pipeW, p.top);
    g.fillRect(p.x, p.top + gap, pipeW, H);
  }
}

function drawUI(){
  g.fillStyle = "#fff";
  g.font = "18px sans-serif";
  g.fillText(`Score: ${score}`, 12, 28);

  if(!started && !dead){
    g.fillStyle = "rgba(0,0,0,.45)";
    g.fillRect(0,0,W,H);
    g.fillStyle = "#fff";
    g.font = "20px sans-serif";
    g.fillText("ğŸ® í´ë¦­/í„°ì¹˜í•˜ë©´ ì‹œì‘!", 62, 240);
    g.font = "13px sans-serif";
    g.fillText("í”ŒëŸ¬í”¼ë„ë¥¼ ë‚ ë ¤ìš” (í´ë¦­=ì í”„)", 66, 268);
  }

  if(dead){
    g.fillStyle = "rgba(0,0,0,.55)";
    g.fillRect(0,0,W,H);
    g.fillStyle = "#fff";
    g.font = "24px sans-serif";
    g.fillText("ğŸ… Game Over", 78, 230);
    g.font = "14px sans-serif";
    g.fillText("í´ë¦­í•˜ë©´ ë‹¤ì‹œ ì‹œì‘", 92, 258);
  }
}

function circleRectCollide(cx, cy, r, rx, ry, rw, rh){
  const closestX = Math.max(rx, Math.min(cx, rx+rw));
  const closestY = Math.max(ry, Math.min(cy, ry+rh));
  const dx = cx - closestX;
  const dy = cy - closestY;
  return (dx*dx + dy*dy) <= r*r;
}

function update(){
  // âœ… ì‹œì‘ ì „ì´ë©´ ë¬¼ë¦¬/ì¶©ëŒ ê³„ì‚° ì•ˆ í•¨ (ì£½ì–´ìˆìŒ ë°©ì§€ í•µì‹¬)
  if(!started || dead) return;

  birdV += gravity;
  birdY += birdV;

  // íŒŒì´í”„ ìƒì„±
  if(frame % 110 === 0) spawnPipe();

  // íŒŒì´í”„ ì´ë™ + ì ìˆ˜
  for(const p of pipes){
    p.x -= speed;

    if(!p.passed && p.x + pipeW < birdX){
      p.passed = true;
      score++;
    }
  }

  // í™”ë©´ ë°– íŒŒì´í”„ ì œê±°
  while(pipes.length && pipes[0].x < -pipeW - 20) pipes.shift();

  // ì¶©ëŒ ì²´í¬
  // ë°”ë‹¥/ì²œì¥
  if(birdY - birdR < 0 || birdY + birdR > H-40) dead = true;

  // íŒŒì´í”„
  for(const p of pipes){
    const hitTop = circleRectCollide(birdX, birdY, birdR, p.x, 0, pipeW, p.top);
    const hitBot = circleRectCollide(birdX, birdY, birdR, p.x, p.top+gap, pipeW, H);
    if(hitTop || hitBot){
      dead = true;
      break;
    }
  }

  frame++;
}

function render(){
  drawBackground();
  drawPipes();
  drawBird();
  drawUI();
}

function loop(){
  update();
  render();
  requestAnimationFrame(loop);
}

// í´ë¦­/í„°ì¹˜ ë™ì‘
cvs.addEventListener("click", () => {
  if(dead){
    resetGame();
    started = true;     // ë°”ë¡œ ì¬ì‹œì‘
    birdV = jumpV;
    return;
  }
  if(!started){
    started = true;     // ì‹œì‘ í™”ë©´ -> í”Œë ˆì´ ì‹œì‘
    birdV = jumpV;
    return;
  }
  birdV = jumpV;        // ì í”„
});

resetGame();
loop();
